<div ng-controller="contracts_controller as cm">
  <div class="row">
    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <nav class="col-md-2 bg-dark text-white p-3 min-vh-100">
      <h5 class="text-white mb-4">åˆåŒç®¡ç†</h5>
      <ul class="nav flex-column">
        <li class="nav-item mb-2" ng-if="hasPermission('contracts:create_contract','ui_control')">
          <a href="" ng-click="cm.navigateTo('build_contract')" class="nav-link text-white">â• æ–°å»ºåˆåŒ</a>
        </li>
        <li class="nav-item mb-2">
          <a href="" ng-click="cm.navigateTo('contracts_list')" class="nav-link text-white">ğŸ“„ åˆåŒåˆ—è¡¨</a>
        </li>
        <li class="nav-item mb-2">
          <a href="" ng-click="cm.navigateTo('lessor_list')" class="nav-link text-white">ğŸ“¨åˆåŒä¸»ä½“åˆ—è¡¨</a>
        </li>
        <li class="nav-item mb-2">
          <a href="" ng-click="cm.navigateTo('workflows_list')" class="nav-link text-white">ğŸ“¨å·²å‘èµ·çš„æµç¨‹</a>
        </li>
      </ul>
    </nav>
    <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
    <main class="col-md-10 px-4 py-4">
      <!-- åˆåŒåˆ—è¡¨ -->
      <section class="position-relative">
        <div ng-show="cm.activeView === 'contracts_list'">

          <!-- æ ‡é¢˜å’Œæ–°å»ºæŒ‰é’® -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0 fs-5 fw-semibold">åˆåŒåˆ—è¡¨</h2>
            <a href="" ng-if="hasPermission('contracts:create_contract','ui_control')"
              ng-click="cm.navigateTo('build_contract')"
              class="text-decoration-none text-primary d-inline-flex align-items-center gap-1 fw-semibold">
              <i class="fa-solid fa-circle-plus"></i> æ–°å»ºåˆåŒ
            </a>
          </div>

          <!-- æŸ¥è¯¢æ¡ä»¶å¡ç‰‡ -->
          <div class="bg-light rounded-3 border p-3 mb-3 shadow-sm">
            <form ng-submit="cm.searchContracts()" class="row g-2 align-items-end">

              <div class="col-md-3">
                <label class="form-label small text-muted">åˆåŒç¼–å·</label>
                <input type="text" class="form-control form-control-sm" ng-model="cm.query.contract_number"
                  placeholder="å¦‚ 2024-C001">
              </div>

              <div class="col-md-2">
                <label class="form-label small text-muted">çŠ¶æ€</label>
                <select class="form-select form-select-sm" ng-model="cm.query.status">
                  <option value="">å…¨éƒ¨</option>
                  <option value="draft">è‰ç¨¿</option>
                  <option value="approve_pending">å®¡æ ¸ä¸­</option>
                  <option value="active">ç”Ÿæ•ˆä¸­</option>
                  <option value="terminated">ç»ˆæ­¢</option>
                  <option value="abnormal">å¼‚å¸¸</option>
                </select>
              </div>

              <div class="col-md-2 d-flex justify-content-end align-items-center">
                <button type="button" class="btn btn-sm btn-outline-secondary"
                  ng-click="cm.advancedSearch = !cm.advancedSearch">
                  é«˜çº§æœç´¢
                  <i class="fa"
                    ng-class="{'fa-chevron-down': !cm.advancedSearch, 'fa-chevron-up': cm.advancedSearch}"></i>
                </button>
              </div>

              <div class="col-md-5 d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-primary btn-sm px-3"><i class="fa fa-search me-1"></i> æŸ¥è¯¢</button>
                <button type="button" class="btn btn-outline-secondary btn-sm px-3" ng-click="cm.resetQuery()"><i
                    class="fa fa-rotate-left me-1"></i> é‡ç½®</button>
              </div>

              <!-- é«˜çº§æœç´¢å­—æ®µæŠ˜å  -->
              <div class="col-12 mt-2" ng-show="cm.advancedSearch">
                <div class="row g-2">
                  <div class="col-md-3">
                    <label class="form-label small text-muted">é¡¹ç›®åç§°</label>
                    <input type="text" class="form-control form-control-sm" ng-model="cm.query.building_name"
                      placeholder="é¡¹ç›®åç§°">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label small text-muted">ç­¾çº¦æ—¥æœŸèŒƒå›´</label>
                    <div class="input-group input-group-sm">
                      <flatpickr-range start-model="cm.query.start_date" end-model="cm.query.end_date"
                        placeholder-start="å¼€å§‹æ—¥æœŸ" placeholder-end="ç»“æŸæ—¥æœŸ"
                        options="{ locale: flatpickr.l10ns.zh, dateFormat: 'Y-m-d' }">
                      </flatpickr-range>
                    </div>
                  </div>
                </div>
              </div>

            </form>
          </div>

          <!-- åˆåŒè¡¨æ ¼ -->
          <table class="table table-hover align-middle mb-0 text-center"
            style="border:1px solid #dee2e6; border-collapse:collapse;">
            <thead class="bg-light text-center fw-semibold">
              <tr>
                <th style="width:50px; border:1px solid #dee2e6;">#</th>
                <th style="border:1px solid #dee2e6;" class="text-start">åˆåŒç¼–å·</th>
                <th style="width:100px; border:1px solid #dee2e6;">çŠ¶æ€</th>
                <th style="width:110px; border:1px solid #dee2e6;">ç­¾çº¦æ—¥æœŸ</th>
                <th style="min-width:240px; white-space:nowrap; border:1px solid #dee2e6;">èµ·æ­¢æ—¥æœŸ</th>
                <th style="border:1px solid #dee2e6;" class="text-start">é¡¹ç›®</th>
                <th style="border:1px solid #dee2e6;" class="text-start">ç§Ÿæˆ·åç§°</th>
                <th style="border:1px solid #dee2e6;" class="text-start">å•å…ƒç¼–å·</th>
                <th style="width:220px; border:1px solid #dee2e6;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="contract in cm.contracts" class="align-middle text-center">
                <td style="border:1px solid #dee2e6;">{{$index + 1}}</td>
                <td style="border:1px solid #dee2e6;" class="text-start fw-semibold text-primary">
                  {{contract.contract_number}}</td>
                <td style="border:1px solid #dee2e6;">
                  <span class="badge rounded-pill px-3 py-1" ng-class="{
                    'bg-success': contract.status === 'active',
                    'bg-secondary': contract.status === 'draft',
                    'bg-danger': contract.status === 'terminated',
                    'bg-warning text-dark': contract.status === 'approve_pending'
                  }">{{contract.status | statusLabel}}</span>
                </td>
                <td style="border:1px solid #dee2e6;">{{contract.sign_date | date:'yyyy-MM-dd'}}</td>
                <td style="border:1px solid #dee2e6; white-space:nowrap;">
                  <div class="small text-muted">
                    {{contract.start_date | date:'yyyy-MM-dd'}} ~ {{contract.end_date | date:'yyyy-MM-dd'}}
                  </div>
                </td>
                <td style="border:1px solid #dee2e6;" class="text-start">{{contract.building_names}}</td>
                <td style="border:1px solid #dee2e6;" class="text-start">{{contract.tenant_name}}</td>
                <td style="border:1px solid #dee2e6;" class="text-start">{{contract.unit_codes}}</td>
                <td style="border:1px solid #dee2e6;">
                  <div class="d-flex justify-content-center flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-primary d-flex align-items-center"
                      ng-click="cm.viewContract(contract)" title="æŸ¥çœ‹åˆåŒ">
                      <i class="bi bi-eye me-1"></i> æŸ¥çœ‹
                    </button>
                    <button class="btn btn-sm btn-outline-success d-flex align-items-center"
                      ui-sref="contract_edit({ id: contract.id })"
                      ng-if="contract.status === 'draft' || contract.status === 'rejected'" title="ç¼–è¾‘åˆåŒ">
                      <i class="bi bi-pencil me-1"></i> ç¼–è¾‘
                    </button>
                    <button class="btn btn-sm btn-outline-danger d-flex align-items-center"
                      ng-if="(contract.status === 'draft' || contract.status === 'rejected') && hasPermission('contracts:delete_contract','ui_control')"
                      ng-click="cm.deleteContract(contract)" title="åˆ é™¤åˆåŒ">
                      <i class="bi bi-trash me-1"></i> åˆ é™¤
                    </button>
                  </div>
                </td>
              </tr>

              <tr ng-if="!cm.contracts.length">
                <td colspan="9" class="text-center py-5 text-muted" style="border:1px solid #dee2e6;">
                  <i class="bi bi-inbox fs-2 d-block mb-2"></i>
                  æš‚æ— ç¬¦åˆæ¡ä»¶çš„åˆåŒæ•°æ®
                </td>
              </tr>
            </tbody>
          </table>


          <!-- åˆ†é¡µæ§ä»¶ -->
          <div class="d-flex justify-content-end mt-2">
            <ul class="pagination mb-0 flex-wrap">
              <li class="page-item" ng-class="{ disabled: cm.query.page === 1 }">
                <button class="page-link btn-sm"
                  ng-click="cm.query.page > 1 && cm.changePage(cm.query.page - 1)">ä¸Šä¸€é¡µ</button>
              </li>

              <li class="page-item" ng-repeat="p in cm.pages track by $index"
                ng-class="{ active: p === cm.query.page }">
                <button class="page-link btn-sm" ng-click="cm.changePage(p)">{{p}}</button>
              </li>

              <li class="page-item" ng-class="{ disabled: cm.query.page === cm.totalPages() }">
                <button class="page-link btn-sm"
                  ng-click="cm.query.page < cm.totalPages() && cm.changePage(cm.query.page + 1)">ä¸‹ä¸€é¡µ</button>
              </li>
            </ul>
          </div>
        </div>
        <!-- æ‚¬æµ®å¾…åŠå…¥å£æŒ‰é’® -->
        <button class="btn btn-primary position-fixed" style="bottom: 30px; right: 30px; z-index: 1050;"
          ng-click="cm.goTasks()">å¾…åŠä»»åŠ¡
          <span class="badge bg-danger ms-1" ng-if="cm.pendingTasksCount > 0">{{ cm.pendingTasksCount }}</span>
        </button>
      </section>
      <!-- å¾…åŠä»»åŠ¡æ¨¡æ€æ¡† -->
      <div class="modal fade" id="pendingTasksModal" tabindex="-1" aria-labelledby="pendingTasksModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content border-0 shadow-lg">
            <!-- Header -->
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="pendingTasksModalLabel">
                æˆ‘çš„å¾…åŠä»»åŠ¡ ({{ cm.pendingTasksCount }})
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
            </div>
            <!-- Body -->
            <div class="modal-body">
              <div class="list-group" ng-if="cm.pendingTasks.length > 0">

                <!-- æ¯ä¸ªä»»åŠ¡ -->
                <a href=""
                  class="list-group-item list-group-item-action flex-column align-items-start mb-3 p-3 rounded shadow-sm"
                  ng-repeat="task in cm.pendingTasks" ng-click="cm.goToTask(task); $event.preventDefault();"
                  style="transition: transform 0.1s;">

                  <!-- ä¸Šæ–¹ï¼šèŠ‚ç‚¹åç§° + çŠ¶æ€ -->
                  <div class="d-flex w-100 justify-content-between align-items-center">
                    <h5 class="mb-1">{{ task.node_name }}</h5>
                    <span class="badge" ng-class="{
                            'bg-warning text-dark': task.status === 'PENDING',
                            'bg-success': task.status === 'APPROVED',
                            'bg-danger': task.status === 'REJECTED'
                          }">{{ task.status | taskStatusLabel }}</span>
                  </div>

                  <!-- ä¸‹æ–¹ï¼šèŠ‚ç‚¹ç±»å‹ã€åˆåŒç¼–å·ã€æ¥æ”¶æ—¶é—´ -->
                  <div class="mt-2 text-muted small">
                    <div><strong>èŠ‚ç‚¹ç±»å‹ï¼š</strong>{{ task.node_name || '-' }}</div>
                    <div><strong>åˆåŒç¼–å·ï¼š</strong>{{ task.contract_number || '-' }}</div>
                    <div><strong>æ¥æ”¶æ—¶é—´ï¼š</strong>{{ task.assigned_at || '-' }}</div>
                  </div>
                </a>
              </div>

              <!-- æ— ä»»åŠ¡ -->
              <div ng-if="cm.pendingTasks.length === 0" class="alert alert-info text-center my-4">
                æš‚æ— å¾…åŠä»»åŠ¡
              </div>
            </div>
            <!-- Footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
          </div>
        </div>
      </div>
      <!-- åˆ›å»ºåˆåŒ -->
      <section>
        <div ng-show="cm.activeView === 'build_contract'" class="container">
          <h3>åˆ›å»ºåˆåŒ</h3>
          <form name="contractForm" ng-submit="cm.submitContract()" novalidate>
            <!-- åˆåŒåŸºæœ¬ä¿¡æ¯ -->
            <div class="card p-3 mb-4">
              <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                  <h5 class="mb-4 text-primary fw-semibold">åˆåŒåŸºæœ¬ä¿¡æ¯</h5>

                  <div class="row g-4 row-cols-1 row-cols-md-3">
                    <div class="col">
                      <label class="form-label">åˆåŒç¼–å·</label>
                      <input type="text" class="form-control" ng-model="cm.contract.contract_number"
                        placeholder="å¦‚:QFZX5-602A-202415" required>
                    </div>

                    <!-- å‡ºç§Ÿäººä¸‹æ‹‰åˆ—è¡¨ -->
                    <div class="col position-relative">
                      <label class="form-label">å‡ºç§Ÿäººï¼ˆä¸»ä½“ï¼‰</label><span class="text-danger">*</span>
                      <input type="text" class="form-control" placeholder="è¯·è¾“å…¥å‡ºç§Ÿäººåç§°..." ng-model="cm.lessorSearch"
                        ng-focus="cm.showLessorDropdown = true" ng-blur="cm.handleLessorBlur()"
                        ng-change="cm.filterLessors()" required />
                      <ul class="list-group position-absolute w-100 shadow-sm zindex-dropdown"
                        ng-show="cm.showLessorDropdown"
                        style="max-height: 200px; overflow-y: auto; top: 100%; left: 0;">
                        <li class="list-group-item text-muted" ng-if="cm.loadingLessors">
                          <i class="fas fa-spinner fa-spin me-1"></i> æ­£åœ¨åŠ è½½å‡ºç§Ÿäºº...
                        </li>
                        <li class="list-group-item list-group-item-action" ng-repeat="lessor in cm.filteredLessors"
                          ng-click="cm.selectLessor(lessor)">
                          {{lessor.name}} <small class="text-muted">(ID: {{lessor.id}})</small>
                        </li>
                        <li class="list-group-item text-muted"
                          ng-if="!cm.loadingLessors && !cm.filteredLessors.length && cm.lessorSearch">
                          æ²¡æœ‰åŒ¹é…çš„å‡ºç§Ÿäºº
                        </li>
                      </ul>
                    </div>
                    <!-- æ‰¿ç§Ÿäººä¸‹æ‹‰æ•°æ® -->
                    <div class="col position-relative">
                      <label class="form-label">æ‰¿ç§Ÿäººï¼ˆä¸»ä½“ï¼‰</label></label><span class="text-danger">*</span></label>
                      <input type="text" class="form-control" placeholder="è¯·è¾“å…¥ç§Ÿæˆ·åç§°..." ng-model="cm.tenantSearch"
                        ng-focus="cm.showTenantDropdown = true" ng-blur="cm.handleTenantBlur()"
                        ng-change="cm.filterTenants()" />

                      <!-- ä¸‹æ‹‰åˆ—è¡¨ -->
                      <ul class="list-group position-absolute w-100 shadow-sm zindex-dropdown"
                        ng-show="cm.showTenantDropdown"
                        style="max-height: 200px; overflow-y: auto; top: 100%; left: 0;">
                        <li class="list-group-item text-muted" ng-if="cm.loadingTenants">
                          <i class="fas fa-spinner fa-spin me-1"></i> æ­£åœ¨åŠ è½½ç§Ÿæˆ·...
                        </li>
                        <li class="list-group-item list-group-item-action" ng-repeat="tenant in cm.filteredTenants"
                          ng-click="cm.selectTenant(tenant)">
                          {{tenant.name}} <small class="text-muted">(ID: {{tenant.id}})</small>
                        </li>
                        <li class="list-group-item text-muted"
                          ng-if="!cm.loadingTenants && !cm.filteredTenants.length && cm.tenantSearch">
                          æ²¡æœ‰åŒ¹é…çš„ç§Ÿæˆ·
                        </li>
                      </ul>
                    </div>

                    <div class="col">
                      <label class="form-label">ç­¾çº¦æ—¥æœŸ</label></label><span class="text-danger">*</span></label>
                      <flatpickr-date ng-model="cm.contract.sign_date" placeholder="ç­¾çº¦æ—¥æœŸ"
                        options="{ locale: flatpickr.l10ns.zh, dateFormat: 'Y-m-d' }" required>
                      </flatpickr-date>
                    </div>

                    <div class="col">
                      <label class="form-label">ä»˜æ¬¾å‘¨æœŸ</label></label><span class="text-danger">*</span></label>
                      <select class="form-select" ng-model="cm.contract.payment_cycle" required>
                        <option value="" disabled selected hidden>è¯·é€‰æ‹©ä»˜æ¬¾å‘¨æœŸ</option>
                        <option value="monthly">æœˆä»˜</option>
                        <option value="quarterly">å­£ä»˜</option>
                        <option value="yearly">å¹´ä»˜</option>
                        <option value="one_time">ä¸€æ¬¡æ€§ä»˜æ¬¾</option>
                      </select>
                    </div>

                    <div class="col">
                      <label class="form-label">å¼€å§‹æ—¥æœŸ</label></label><span class="text-danger">*</span></label>
                      <flatpickr-date ng-model="cm.contract.start_date" placeholder="å¼€å§‹æ—¥æœŸ"
                        options="{ locale: flatpickr.l10ns.zh, dateFormat: 'Y-m-d' }" required>
                      </flatpickr-date>
                    </div>

                    <div class="col">
                      <label class="form-label">ç»“æŸæ—¥æœŸ</label></label><span class="text-danger">*</span></label>
                      <flatpickr-date ng-model="cm.contract.end_date" placeholder="ç»“æŸæ—¥æœŸ"
                        options="{ locale: flatpickr.l10ns.zh, dateFormat: 'Y-m-d' }" required>
                      </flatpickr-date>
                    </div>

                    <div class="col-12">
                      <label class="form-label">å¤‡æ³¨</label>
                      <textarea class="form-control" rows="2" ng-model="cm.contract.remarks"></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- ç­¾çº¦å•å…ƒé€‰æ‹©ï¼ˆåˆ†çº§åŠ è½½ï¼‰ -->
            <div class="card shadow-sm border-0 mb-4">
              <div class="card-body">
                <h5 class="mb-4 text-primary fw-semibold">ç­¾çº¦å•å…ƒé€‰æ‹©</h5>

                <!-- é¡¹ç›®é€‰æ‹© -->
                <div class="row g-4 mb-3">
                  <div class="col-md-6 col-lg-4">
                    <label class="form-label">é€‰æ‹©é¡¹ç›®</label></label><span class="text-danger">*</span></label>
                    <select class="form-select" ng-model="cm.selectedBuilding"
                      ng-options="b as b.name for b in cm.buildings" ng-change="cm.onBuildingChange()">
                      <option value="">è¯·é€‰æ‹©é¡¹ç›®</option>
                    </select>
                  </div>

                  <div class="col-md-6 col-lg-4" ng-if="cm.floors.length > 0">
                    <label class="form-label">é€‰æ‹©æ¥¼å±‚</label></label><span class="text-danger">*</span></label>
                    <select class="form-select" ng-model="cm.selectedFloor"
                      ng-options="f as f.level + 'å±‚' for f in cm.floors" ng-change="cm.loadUnits()">
                      <option value="">è¯·é€‰æ‹©æ¥¼å±‚</option>
                    </select>
                  </div>
                </div>

                <!-- å¯é€‰å•å…ƒåˆ—è¡¨ -->
                <div class="mb-4" ng-if="cm.availableUnits.length > 0">
                  <label class="form-label fw-semibold mb-2">å¯é€‰å•å…ƒåˆ—è¡¨</label></label><span
                    class="text-danger">*</span></label>

                  <div class="table-responsive">
                    <table class="table table-hover table-bordered align-middle text-center mb-3">
                      <thead class="table-light">
                        <tr>
                          <th style="width: 60px;">é€‰æ‹©</th>
                          <th>å•å…ƒç¼–å·</th>
                          <th>å‡ºç§Ÿé¢ç§¯</th>
                          <th>æŒ‚ç‰Œå•ä»·</th>
                          <th>ç®¡ç†è´¹å•ä»·</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr ng-repeat="u in cm.availableUnits">
                          <td>
                            <input type="checkbox" ng-model="u.selected" class="form-check-input m-0" />
                          </td>
                          <td class="fw-semibold text-truncate" style="max-width: 140px;">{{ u.code }}</td>
                          <td>{{ u.lease_area }}ã¡</td>
                          <td>Â¥{{ u.rent_unit_price | number:2 }}</td>
                          <td>Â¥{{ u.management_fee_per_sqm | number:2 }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="text-end">
                    <button type="button" class="btn btn-primary btn-sm px-4" ng-click="cm.addSelectedUnits()"
                      ng-disabled="!cm.hasSelectedUnits()">
                      æ·»åŠ é€‰ä¸­å•å…ƒ
                    </button>
                  </div>
                </div>
                <!-- å·²æ·»åŠ å•å…ƒåˆ—è¡¨ -->
                <div ng-if="cm.formData.units.length > 0">
                  <h6 class="mb-3 fw-semibold text-primary">å·²é€‰ç­¾çº¦å•å…ƒ</h6>
                  <div ng-repeat="unit in cm.formData.units track by unit.unit_id"
                    class="border rounded p-3 mb-3 bg-light-subtle shadow-sm">
                    <div class="row g-3 align-items-center">
                      <div class="col-md-2">
                        <label class="form-label">å•å…ƒID</label>
                        <div>{{unit.unit_id}}</div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">å•å…ƒç¼–å·</label>
                        <div>{{unit.unit_code}}</div>
                      </div>
                      <div class="col-md-2">
                        <label class="form-label">å‡ºç§Ÿé¢ç§¯ï¼ˆã¡ï¼‰</label>
                        <div>{{unit.lease_area}}</div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">æŒ‚ç‰Œç§Ÿé‡‘ï¼ˆå…ƒ/ã¡ï¼‰</label>
                        <div>{{unit.rent_unit_price}}</div>
                      </div>
                      <div class="col-md-2">
                        <label class="form-label">æŒ‚ç‰Œç®¡ç†è´¹å•ä»·ï¼ˆå…ƒ/ã¡ï¼‰</label>
                        <div>{{unit.deal_management_fee_per_sqm}}</div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">æˆäº¤å•ä»·ï¼ˆå…ƒ/ã¡ï¼‰ <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" ng-model="unit.deal_unit_price"
                          placeholder="è¯·è¾“å…¥æˆäº¤ç§Ÿé‡‘å•ä»·" step="0.01">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">æˆäº¤ç®¡ç†è´¹å•ä»·ï¼ˆå…ƒ/ã¡ï¼‰<span class="text-danger">*</span></label>
                        <input type="number" class="form-control" placeholder="è¯·è¾“å…¥æˆäº¤ç®¡ç†è´¹å•ä»·"
                          ng-model="cm.termOptions.serviceRate" required>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">å¤‡æ³¨</label>
                        <input type="text" class="form-control" ng-model="unit.remarks" placeholder="è¯·è¾“å…¥å¤‡æ³¨">
                      </div>
                      <div class="col-md-1 d-flex align-items-end justify-content-end">
                        <button type="button" class="btn btn-outline-danger btn-sm"
                          ng-click="cm.removeUnitById(unit.unit_id)">
                          åˆ é™¤
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- æŸ¥è¯¢å®Œä½†æ— æ•°æ® -->
                <div class="alert alert-warning text-center py-3"
                  ng-if="cm.unitsLoaded && cm.availableUnits.length === 0">æš‚æ— å¯ç”¨å•å…ƒï¼Œè¯·æ£€æŸ¥è¯¥æ¥¼å±‚æ˜¯å¦æœ‰ç©ºç½®æˆ¿æº
                </div>
              </div>
            </div>
            <!-- æ¡æ¬¾è®¾ç½® -->
            <div class="card shadow-sm border-0 mb-4">
              <div class="card-body">
                <h5 class="mb-4 text-primary fw-semibold">æ¡æ¬¾è®¾ç½®</h5>
                <!-- åŸºç¡€æ¡æ¬¾ -->
                <div class="row g-3 align-items-center mb-2">
                  <div class="col-md-4">
                    <label class="form-label">èµ·å§‹ç§Ÿé‡‘ï¼ˆå…ƒ/ã¡ï¼‰<span class="text-danger">*</span></label>
                    <input type="number" class="form-control" ng-model="cm.termOptions.baseRentRate" step="0.01"
                      disabled>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">æ‹†åˆ†æ–¹å¼<span class="text-danger">*</span></label>
                    <select class="form-select" ng-model="cm.termOptions.splitMode" required>
                      <option value="" disabled selected hidden>è¯·é€‰æ‹©æ‹†åˆ†æ–¹å¼</option>
                      <option value="NATURAL_MONTH">è‡ªç„¶æœˆ</option>
                      <option value="FULL_MONTH">æ•´æœˆå‘¨æœŸï¼ˆæš‚ä¸æ”¯æŒï¼‰</option>
                    </select>
                  </div>
                </div>

                <div class="col-md-3">
                  <label class="form-label">ä¿è¯é‡‘ï¼ˆå…ƒï¼‰<span class="text-danger">*</span></label>
                  <div class="input-group mb-1">
                    <select class="form-select" ng-model="cm.depositOption" ng-change="cm.updateDeposit()">
                      <option value="1">ä¸€æŠ¼</option>
                      <option value="2">äºŒæŠ¼</option>
                      <option value="3">ä¸‰æŠ¼</option>
                      <option value="custom">è‡ªå®šä¹‰</option>
                    </select>

                    <input type="number" class="form-control" ng-model="cm.contract.deposit_amount"
                      ng-readonly="cm.depositOption !== 'custom'" required>
                  </div>
                </div><br>
                <!-- ç§Ÿé‡‘é€’å¢è§„åˆ™ -->
                <div class="mb-4">
                  <label class="form-label fw-semibold mb-2">ç§Ÿé‡‘é€’å¢</label>
                  <div ng-repeat="rule in cm.termOptions.increaseRules track by $index"
                    class="row g-3 align-items-center mb-2">
                    <div class="col-md-3">
                      <select class="form-select" ng-model="rule.type" required>
                        <option value="ANNIVERSARY">å‘¨å¹´é€’å¢</option>
                        <option value="POINT">æŒ‡å®šæ—¥æœŸé€’å¢</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <flatpickr-date ng-if="rule.type === 'ANNIVERSARY'" ng-model="rule.anchorDate" placeholder="é€‰æ‹©åŸºå‡†æ—¥"
                        options="{ locale: flatpickr.l10ns.zh, dateFormat: 'Y-m-d' }" required>
                      </flatpickr-date>

                      <flatpickr-date ng-if="rule.type === 'POINT'" ng-model="rule.effectiveDate" placeholder="ç”Ÿæ•ˆæ—¥æœŸ"
                        options="{ locale: flatpickr.l10ns.zh, dateFormat: 'Y-m-d' }" required>
                      </flatpickr-date>
                    </div>

                    <div class="col-md-3">
                      <input type="number" step="0.01" class="form-control" ng-model="rule.rate" placeholder="é€’å¢æ¯”ä¾‹"
                        required>
                    </div>

                    <div class="col-md-3 d-flex align-items-center gap-2">
                      <button type="button" class="btn btn-sm btn-outline-danger flex-fill"
                        ng-click="cm.removeIncreaseRule($index)">
                        <i class="fas fa-trash-alt me-1"></i>åˆ é™¤
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-info flex-fill"
                        ng-click="cm.appendIncreaseRuleToRemarks()">
                        <i class="fas fa-comment-dots me-1"></i>å¡«å…¥å¤‡æ³¨
                      </button>
                    </div>

                  </div>
                  <!-- ç§»åŠ¨æŒ‰é’®åˆ°æ­¤é è¿‘åŒºåŸŸ -->
                  <button type="button" class="btn btn-outline-secondary btn-sm" ng-click="cm.addIncreaseRule()">
                    æ·»åŠ é€’å¢è§„åˆ™
                  </button>
                </div>
                <!-- å…ç§ŸæœŸè®¾ç½® -->
                <div>
                  <label class="form-label fw-semibold mb-2">å…ç§ŸæœŸ</label>
                  <div ng-repeat="free in cm.termOptions.freePeriods track by $index"
                    class="row g-3 align-items-center mb-2">
                    <div class="col-md-4">
                      <flatpickr-date ng-model="free.startDate" placeholder="å¼€å§‹æ—¥æœŸ"
                        options="{ locale: flatpickr.l10ns.zh, dateFormat: 'Y-m-d' }" required>
                      </flatpickr-date>
                    </div>

                    <div class="col-md-4">
                      <flatpickr-date ng-model="free.endDate" placeholder="ç»“æŸæ—¥æœŸ"
                        options="{ locale: flatpickr.l10ns.zh, dateFormat: 'Y-m-d' }" required>
                      </flatpickr-date>
                    </div>

                    <div class="col-md-4 d-flex align-items-center gap-2">
                      <button type="button" class="btn btn-sm btn-outline-danger flex-fill"
                        ng-click="cm.removeFreePeriod($index)">
                        <i class="fas fa-trash-alt me-1"></i>åˆ é™¤
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-info flex-fill"
                        ng-click="cm.appendFreePeriodClause()">
                        <i class="fas fa-comment-dots me-1"></i>å¡«å…¥å¤‡æ³¨
                      </button>
                    </div>
                  </div>
                  <button type="button" class="btn btn-outline-secondary btn-sm" ng-click="cm.addFreePeriod()">
                    æ·»åŠ å…ç§ŸæœŸ
                  </button>
                </div>
              </div>
            </div>
            <file-upload file-model="cm.contractFile" file-name="cm.contractFileName"
              uploaded-files="cm.formData.uploadedFiles">
            </file-upload>
            <!-- é¢„è§ˆåˆåŒæ¨¡æ€æ¡† -->
            <div class="modal fade" id="contractPreviewModal" tabindex="-1" aria-labelledby="contractPreviewLabel"
              aria-hidden="true">
              <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">

                  <!-- Header -->
                  <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title" id="contractPreviewLabel">
                      <i class="bi bi-file-earmark-text me-2"></i>æ¡æ¬¾é¢„è§ˆ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>

                  <div class="modal-body">
                    <!-- å…³é”®æ—¥æœŸè¿›åº¦æ¡ -->
                    <div class="mb-4">
                      <div class="d-flex justify-content-between small text-muted">
                        <div>ç­¾çº¦æ—¥æœŸï¼š{{cm.contract.sign_date | date:'yyyy-MM-dd'}}</div>
                        <div>èµ·ç§Ÿæ—¥æœŸï¼š{{cm.contract.start_date | date:'yyyy-MM-dd'}}</div>
                        <div>åˆ°æœŸæ—¥æœŸï¼š{{cm.contract.end_date | date:'yyyy-MM-dd'}}</div>
                      </div>
                      <div class="progress mt-2" style="height:6px;">
                        <div class="progress-bar bg-success" style="width:33%;"></div>
                        <div class="progress-bar bg-warning" style="width:62%;"></div>
                        <div class="progress-bar bg-danger" style="width:5%;"></div>
                      </div>
                    </div>

                    <!-- åŸºæœ¬ä¿¡æ¯ & æ¡æ¬¾ è®¾ç½® -->
                    <div class="row g-3 mb-4">
                      <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                          <div class="card-header bg-light">
                            <i class="bi bi-info-circle me-1"></i><strong>åŸºæœ¬ä¿¡æ¯</strong>
                          </div>
                          <div class="card-body">
                            <ul class="list-unstyled mb-0">
                              <li><strong>åˆåŒç¼–å·ï¼š</strong>{{cm.contract.contract_number}}</li>
                              <li><strong>å‡ºç§Ÿäººï¼ˆä¸»ä½“ï¼‰ï¼š</strong>{{cm.pre_contract.lessor.name}}</li>
                              <li><strong>æ‰¿ç§Ÿäººï¼ˆä¸»ä½“ï¼‰ï¼š</strong>{{cm.pre_contract.tenant.name || '-'}}</li>
                              <li><strong>ç­¾çº¦æ—¥æœŸï¼š</strong>{{cm.contract.sign_date | date:'yyyy-MM-dd'}}</li>
                              <li><strong>å¤‡æ³¨ï¼š</strong>{{cm.contract.remarks || 'â€”'}}</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                          <div class="card-header bg-light">
                            <i class="bi bi-gear-fill me-1"></i><strong>æ¡æ¬¾è®¾ç½®</strong>
                          </div>
                          <div class="card-body">
                            <ul class="list-unstyled mb-0">
                              <li><strong>ä»˜æ¬¾å‘¨æœŸï¼š</strong>{{cm.contract.payment_cycle==='monthly'?'æŒ‰æœˆ':'æŒ‰å­£'}}</li>
                              <li><strong>èµ·å§‹ / ç»“æŸï¼š</strong>{{cm.contract.start_date | date:'yyyy-MM-dd'}} ~
                                {{cm.contract.end_date | date:'yyyy-MM-dd'}}</li>
                              <li><strong>èµ·å§‹ç§Ÿé‡‘ï¼š</strong>Â¥{{cm.termOptions.baseRentRate | number:2}}/ã¡</li>
                              <li><strong>ç®¡ç†è´¹ï¼š</strong>Â¥{{cm.termOptions.serviceRate | number:2}}/ã¡</li>
                              <li><strong>æ‹†åˆ†æ–¹å¼ï¼š</strong>{{cm.termOptions.splitMode==='NATURAL_MONTH'?'è‡ªç„¶æœˆ':'æ•´æœˆå‘¨æœŸ'}}</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- ç­¾çº¦å•å…ƒ -->
                    <div class="card mb-4 shadow-sm">
                      <div class="card-header bg-light">
                        <i class="bi bi-house-door me-1"></i><strong>ç­¾çº¦å•å…ƒ ({{cm.formData.units.length}})</strong>
                      </div>
                      <div class="card-body p-0">
                        <div class="table-responsive">
                          <table class="table table-hover mb-0">
                            <thead class="table-light text-center">
                              <tr>
                                <th>ID</th>
                                <th>ç¼–å·</th>
                                <th>é¢ç§¯</th>
                                <th>æŒ‚ç‰Œç§Ÿé‡‘</th>
                                <th>æˆäº¤å•ä»·</th>
                                <th>ç®¡ç†è´¹</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr ng-repeat="unit in cm.formData.units">
                                <td>{{unit.unit_id}}</td>
                                <td>{{unit.unit_code}}</td>
                                <td>{{unit.lease_area}}ã¡</td>
                                <td>Â¥{{unit.rent_unit_price | number:2}}</td>
                                <td>Â¥{{unit.deal_unit_price | number:2}}</td>
                                <td>Â¥{{unit.deal_management_fee_per_sqm | number:2}}</td>
                              </tr>
                              <tr ng-if="!cm.formData.units.length">
                                <td colspan="6" class="text-center text-muted">æœªæ·»åŠ å•å…ƒ</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>

                    <!-- é€’å¢è§„åˆ™ & å…ç§ŸæœŸ -->
                    <div class="row g-4 mb-4">
                      <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                          <div class="card-header bg-light">
                            <i class="bi bi-arrow-up-right-circle me-1"></i><strong>é€’å¢è§„åˆ™</strong>
                          </div>
                          <div class="card-body p-0">
                            <ul class="list-group list-group-flush">
                              <li class="list-group-item d-flex justify-content-between align-items-center"
                                ng-repeat="rule in cm.termOptions.increaseRules">
                                {{rule.type==='ANNIVERSARY'?'å‘¨å¹´é€’å¢':'æŒ‡å®šæ—¥æœŸé€’å¢'}}
                                <span>{{(rule.anchorDate||rule.effectiveDate)|date:'yyyy-MM-dd'}}</span>
                                <span class="badge bg-primary rounded-pill ms-2">{{(rule.rate*100)|number:2}}%</span>
                              </li>
                              <li class="list-group-item text-center text-muted"
                                ng-if="!cm.termOptions.increaseRules.length">
                                æ— é€’å¢è§„åˆ™
                              </li>
                            </ul>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                          <div class="card-header bg-light">
                            <i class="bi bi-clock-history me-1"></i><strong>å…ç§ŸæœŸ</strong>
                          </div>
                          <div class="card-body p-0">
                            <ul class="list-group list-group-flush">
                              <li class="list-group-item d-flex justify-content-between"
                                ng-repeat="free in cm.termOptions.freePeriods">
                                <span>{{free.startDate|date:'yyyy-MM-dd'}} ~ {{free.endDate|date:'yyyy-MM-dd'}}</span>
                              </li>
                              <li class="list-group-item text-center text-muted"
                                ng-if="!cm.termOptions.freePeriods.length">
                                æ— å…ç§ŸæœŸ
                              </li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Footer -->
                  <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                      <i class="bi bi-x-circle me-1"></i>å…³é—­
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="d-flex justify-content-end gap-2 mb-3">
              <button type="button" class="btn btn-info" ng-disabled="contractForm.$invalid"
                ng-click="cm.openPreview()">é¢„è§ˆæ¡æ¬¾</button>
              <button type="submit" class="btn btn-primary" ng-disabled="contractForm.$invalid">ä¿å­˜æ¡æ¬¾</button>
            </div>
          </form>
        </div>
        <!-- Toast å®¹å™¨ -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3 z-3">
          <div id="appToast" class="toast align-items-center text-white bg-success border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">æç¤ºå†…å®¹</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="å…³é—­"></button>
            </div>
          </div>
        </div>
      </section>
      <!-- åˆåŒä¸»ä½“ç»´æŠ¤åˆ—è¡¨ -->
      <section>
        <div ng-show="cm.activeView === 'lessor_list'">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>åˆåŒä¸»ä½“åˆ—è¡¨</h4>
            <button class="btn btn-primary" ng-click="cm.openLessorModal()">
              <i class="bi bi-plus-lg"></i> æ–°å¢å‡ºç§Ÿäºº
            </button>
          </div>

          <table class="table table-bordered table-hover">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>åç§°</th>
                <th>è”ç³»äºº</th>
                <th>ç”µè¯</th>
                <th>é‚®ç®±</th>
                <th>åœ°å€</th>
                <th>ç¨å·</th>
                <th>å¼€æˆ·è¡Œ/è´¦å·</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="lessor in cm.lessors">
                <td>{{lessor.id}}</td>
                <td>{{lessor.name}}</td>
                <td>{{lessor.contact_person}}</td>
                <td>{{lessor.contact_phone}}</td>
                <td>{{lessor.email}}</td>
                <td>{{lessor.address}}</td>
                <td>{{lessor.tax_number}}</td>
                <td>
                  <div>{{lessor.bank_name}}</div>
                  <div>{{lessor.bank_account_number}}</div>
                </td>
                <td>
                  <button class="btn btn-sm btn-secondary me-1" ng-click="cm.openLessorModal(lessor)">ç¼–è¾‘</button>
                  <button class="btn btn-sm btn-danger" ng-click="cm.deleteLessor(lessor.id)">åˆ é™¤</button>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- åˆ†é¡µï¼ˆå¯é€‰ï¼‰ -->
          <nav aria-label="å‡ºç§Ÿäººåˆ†é¡µ">
            <ul class="pagination justify-content-center">
              <li class="page-item" ng-class="{ disabled: cm.lessorPage===1 }">
                <button class="page-link" ng-click="cm.changeLessorPage(cm.lessorPage-1)">ä¸Šä¸€é¡µ</button>
              </li>
              <li class="page-item" ng-repeat="p in [].constructor(cm.lessorTotalPages) track by $index"
                ng-class="{ active: cm.lessorPage===$index+1 }">
                <button class="page-link" ng-click="cm.changeLessorPage($index+1)">{{$index+1}}</button>
              </li>
              <li class="page-item" ng-class="{ disabled: cm.lessorPage===cm.lessorTotalPages }">
                <button class="page-link" ng-click="cm.changeLessorPage(cm.lessorPage+1)">ä¸‹ä¸€é¡µ</button>
              </li>
            </ul>
          </nav>

          <!-- æ–°å¢/ç¼–è¾‘æ¨¡æ€æ¡† -->
          <div class="modal fade" id="lessorModal" tabindex="-1" aria-labelledby="lessorModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="lessorModalLabel">{{cm.editingLessor.id ? 'ç¼–è¾‘å‡ºç§Ÿäºº' : 'æ–°å¢å‡ºç§Ÿäºº'}}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form name="lessorForm" novalidate ng-submit="cm.saveLessor()">
                  <div class="modal-body">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">åç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" ng-model="cm.editingLessor.name" required>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">è”ç³»äºº</label>
                        <input type="text" class="form-control" ng-model="cm.editingLessor.contact_person">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">ç”µè¯</label>
                        <input type="text" class="form-control" ng-model="cm.editingLessor.contact_phone">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">ç”µå­é‚®ç®±</label>
                        <input type="email" class="form-control" ng-model="cm.editingLessor.email">
                      </div>
                      <div class="col-md-12">
                        <label class="form-label">åœ°å€</label>
                        <input type="text" class="form-control" ng-model="cm.editingLessor.address">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">æ³•å®šä»£è¡¨äºº</label>
                        <input type="text" class="form-control" ng-model="cm.editingLessor.legal_person">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">ç¨å·</label>
                        <input type="text" class="form-control" ng-model="cm.editingLessor.tax_number">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">å¼€æˆ·é“¶è¡Œ</label>
                        <input type="text" class="form-control" ng-model="cm.editingLessor.bank_name">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">é“¶è¡Œè´¦å·</label>
                        <input type="text" class="form-control" ng-model="cm.editingLessor.bank_account_number">
                      </div>
                      <div class="col-md-12">
                        <label class="form-label">å¤‡æ³¨</label>
                        <textarea class="form-control" rows="3" ng-model="cm.editingLessor.remarks"></textarea>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" ng-disabled="lessorForm.$invalid">ä¿å­˜</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- æˆ‘å‘èµ·çš„æµç¨‹ -->
      <section ng-show="cm.activeView === 'workflows_list'" class="p-3">
        <h4>å·²å‘èµ·çš„æµç¨‹</h4>

        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>æµç¨‹ç¼–å·</th>
              <th>åˆåŒç¼–å·</th>
              <th>é¡¹ç›®åç§°</th>
              <th>å¤‡æ³¨</th>
              <th>çŠ¶æ€</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="flow in cm.workflows">
              <td>{{flow.business_key}}</td>
              <td>{{flow.context_json.contract_number}}</td>
              <td>{{flow.context_json.building_name}}</td>
              <td>{{flow.context_json.remarks}}</td>
              <td>
                <span class="badge bg-warning" ng-if="flow.status === 'RUNNING'">å®¡æ‰¹ä¸­</span>
                <span class="badge bg-success" ng-if="flow.status === 'APPROVED'">å·²å®¡æ ¸</span>
                <span class="badge bg-danger" ng-if="flow.status === 'REJECTED'">å·²é©³å›</span>
              </td>
              <td>{{flow.started_at | date:'yyyy-MM-dd HH:mm:ss'}}</td>
              <td>
                <button class="btn btn-sm btn-primary" ng-click="cm.viewWorkflow(flow)">æŸ¥çœ‹</button>
              </td>
            </tr>
            <tr ng-if="!cm.workflows || cm.workflows.length === 0">
              <td colspan="7" class="text-center text-muted">æš‚æ— æµç¨‹</td>
            </tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>
</div>